import re

from paramiko.client import SSHClient

from models.common import Chrome
from models.connection_info import ConnectionInfo

minimum_allowed_version = Chrome.ChromeVersion.from_string("125.0.6422.60")


class CommandExecutionError(Exception):
    pass


def get_version(stdout: str) -> Chrome.ChromeVersion:
    version_match = re.search("Google Chrome (.+)", stdout)
    if version_match:
        return Chrome.ChromeVersion.from_string(version_match.group(1))
    raise Exception(f"Could not find Google Chrome version in {stdout}")


def check(client: SSHClient, client_info: ConnectionInfo) -> bool:
    command = "google-chrome --version"
    print(f"executing command: {command}")
    stdin, stdout, stderr = client.exec_command(command)
    error = stderr.read().decode()
    if error:
        raise CommandExecutionError(error)
    stdout = stdout.read().decode()
    current_version = get_version(stdout)
    print(f"current client Chrome version: {current_version}")
    return current_version <= minimum_allowed_version
