import paramiko
from paramiko.client import SSHClient, AutoAddPolicy

from models.connection_info import ConnectionInfo


class CommandExecutionError(Exception):
    pass


def mitigate(client: SSHClient, client_info: ConnectionInfo) -> bool:
    command = f"echo {client_info.password} | sudo -k -S apt-get -y upgrade google-chrome-stable"
    print(f"executing command: {command}")
    stdin, stdout, stderr = client.exec_command(command)
    exit_code = stdout.channel.recv_exit_status()
    if exit_code != 0:
        error = stderr.read().decode()
        raise CommandExecutionError(error)
    print("mitigation finished successfully")
    return True

# if __name__ == '__main__':
#     client = SSHClient()
#     client.set_missing_host_key_policy(AutoAddPolicy())
#     client.connect(hostname="10.100.102.12", username="jhon-doe", password="a")
#     mitigate(client, ConnectionInfo(**{
#         "host": "10.100.102.12",
#         "username": "jhon-doe",
#         "password": "a"
#     }))
